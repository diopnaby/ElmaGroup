{% extends "base.html" %}

{% block title %}{{ book.title }} - Bibliothèque ELMA Group{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="row">
        <div class="col-12">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{{ url_for('main.index') }}">Accueil</a></li>
                    <li class="breadcrumb-item"><a href="{{ url_for('library.index') }}">Bibliothèque</a></li>
                    <li class="breadcrumb-item active">{{ book.title }}</li>
                </ol>
            </nav>
        </div>
    </div>
    
    <div class="row">
        <div class="col-lg-4">
            <div class="book-cover-section text-center">
                {% if book.cover_image %}
                <img src="{{ book.cover_image }}" class="img-fluid rounded shadow" alt="{{ book.title }}" style="max-height: 400px;">
                {% else %}
                <div class="bg-light rounded shadow d-flex align-items-center justify-content-center" style="height: 400px; width: 100%;">
                    <i class="fas fa-book fa-4x text-muted"></i>
                </div>
                {% endif %}
                
                {% if book.current_price %}
                <div class="mt-3">
                    <h4 class="book-price text-success">{{ book.formatted_price }}</h4>
                    {% if book.is_on_sale %}
                    <small class="book-price-old">{{ book.price|format_price(book.currency) }}</small>
                    {% endif %}
                </div>
                {% endif %}
                
                <div class="mt-3">
                    {% if book.availability_status == 'available' %}
                    <span class="badge bg-success">Disponible</span>
                    {% elif book.availability_status == 'out_of_stock' %}
                    <span class="badge bg-warning">Rupture de stock</span>
                    {% elif book.availability_status == 'pre_order' %}
                    <span class="badge bg-info">Pré-commande</span>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <div class="col-lg-8">
            <div class="book-details">
                <h1 class="display-5 fw-bold">{{ book.title }}</h1>
                {% if book.subtitle %}
                <h2 class="h4 text-muted mb-3">{{ book.subtitle }}</h2>
                {% endif %}
                
                <div class="book-meta mb-4">
                    {% if book.authors %}
                    <p class="mb-2">
                        <strong>Auteur(s):</strong>
                        {% for author in book.authors %}
                        <a href="{{ url_for('library.author_detail', slug=author.slug) }}" class="text-decoration-none">{{ author.name }}</a>{% if not loop.last %}, {% endif %}
                        {% endfor %}
                    </p>
                    {% endif %}
                    
                    {% if book.publisher %}
                    <p class="mb-2"><strong>Éditeur:</strong> {{ book.publisher.name }}</p>
                    {% endif %}
                    
                    {% if book.book_category %}
                    <p class="mb-2"><strong>Catégorie:</strong> {{ book.book_category.name }}</p>
                    {% endif %}
                    
                    {% if book.publication_date %}
                    <p class="mb-2"><strong>Date de publication:</strong> {{ book.publication_date.strftime('%d/%m/%Y') }}</p>
                    {% endif %}
                    
                    {% if book.page_count %}
                    <p class="mb-2"><strong>Nombre de pages:</strong> {{ book.page_count }}</p>
                    {% endif %}
                    
                    {% if book.isbn_13 %}
                    <p class="mb-2"><strong>ISBN:</strong> {{ book.isbn_13 }}</p>
                    {% endif %}
                    
                    {% if book.language %}
                    <p class="mb-2"><strong>Langue:</strong> {{ book.language }}</p>
                    {% endif %}
                </div>
                
                {% if reviews %}
                <div class="book-rating mb-4">
                    <div class="d-flex align-items-center">
                        <div class="star-rating me-3">
                            {{ book.average_rating|star_rating|safe }}
                        </div>
                        <span class="text-muted">{{ book.average_rating|round(1) }}/5 ({{ book.review_count }} avis)</span>
                    </div>
                </div>
                {% endif %}
                
                {% if book.description %}
                <div class="book-description mb-4">
                    <h3>Description</h3>
                    <div class="text-content">{{ book.description|safe }}</div>
                </div>
                {% endif %}
                
                {% if book.abstract %}
                <div class="book-abstract mb-4">
                    <h3>Résumé</h3>
                    <div class="text-content">{{ book.abstract|safe }}</div>
                </div>
                {% endif %}
                
                {% if book.tags %}
                <div class="book-tags mb-4">
                    <h5>Tags</h5>
                    {% for tag in book.tags %}
                    <span class="badge bg-secondary me-1">{{ tag.name }}</span>
                    {% endfor %}
                </div>
                {% endif %}
                
                {% if book.collections %}
                <div class="book-collections mb-4">
                    <h5>Collections</h5>
                    {% for collection in book.collections %}
                    <a href="{{ url_for('main.collection_detail', slug=collection.slug) }}" class="badge bg-primary text-decoration-none me-1">{{ collection.name }}</a>
                    {% endfor %}
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- Reviews Section -->
    {% if reviews %}
    <div class="row mt-5">
        <div class="col-12">
            <h3>Avis des lecteurs</h3>
            
            {% for review in reviews %}
            <div class="review mb-4 p-3 border rounded">
                <div class="review-header d-flex justify-content-between align-items-start mb-2">
                    <div>
                        <h6 class="mb-1">{{ review.reviewer_name }}</h6>
                        <div class="star-rating">
                            {{ review.rating|star_rating|safe }}
                        </div>
                    </div>
                    <small class="text-muted">{{ review.created_at.strftime('%d/%m/%Y') }}</small>
                </div>
                
                {% if review.title %}
                <h6 class="review-title">{{ review.title }}</h6>
                {% endif %}
                
                <div class="review-content">
                    {{ review.content|nl2br|safe }}
                </div>
                
                {% if review.pros or review.cons %}
                <div class="review-pros-cons mt-3">
                    {% if review.pros %}
                    <div class="pros mb-2">
                        <strong class="text-success">Points positifs:</strong> {{ review.pros }}
                    </div>
                    {% endif %}
                    {% if review.cons %}
                    <div class="cons">
                        <strong class="text-danger">Points négatifs:</strong> {{ review.cons }}
                    </div>
                    {% endif %}
                </div>
                {% endif %}
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}
    
    <!-- Related Books -->
    {% if related_books %}
    <div class="row mt-5">
        <div class="col-12">
            <h3 class="mb-4">Livres similaires</h3>
        </div>
        {% for related_book in related_books %}
        <div class="col-lg-3 col-md-4 col-sm-6 mb-4">
            <div class="card book-card h-100">
                {% if related_book.cover_image %}
                <img src="{{ related_book.cover_image }}" class="card-img-top book-cover" alt="{{ related_book.title }}">
                {% else %}
                <div class="card-img-top book-cover bg-light d-flex align-items-center justify-content-center">
                    <i class="fas fa-book fa-2x text-muted"></i>
                </div>
                {% endif %}
                <div class="card-body d-flex flex-column">
                    <h6 class="card-title">{{ related_book.title }}</h6>
                    <p class="card-text small">{{ related_book.author_names }}</p>
                    {% if related_book.current_price %}
                    <div class="mt-auto book-price">{{ related_book.formatted_price }}</div>
                    {% endif %}
                    <a href="{{ url_for('library.book_detail', slug=related_book.slug) }}" class="btn btn-sm btn-outline-primary mt-2">
                        Voir détails
                    </a>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% endif %}
</div>
{% endblock %}
